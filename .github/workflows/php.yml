name: PHP Composer & Deploy to DirectAdmin

on:
  push:
    branches: [ "main" ]   # Tá»± Ä‘á»™ng cháº¡y khi push lÃªn nhÃ¡nh main
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1ï¸âƒ£ Láº¥y code tá»« GitHub
    - name: ğŸ“¦ Checkout source code
      uses: actions/checkout@v4

    # 2ï¸âƒ£ Kiá»ƒm tra composer.json
    - name: ğŸ§© Validate composer.json and composer.lock
      run: composer validate --strict

    # 3ï¸âƒ£ Cache thÆ° viá»‡n Composer Ä‘á»ƒ tÄƒng tá»‘c build
    - name: âš¡ Cache Composer packages
      id: composer-cache
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    # 4ï¸âƒ£ CÃ i Ä‘áº·t dependencies PHP
    - name: ğŸ“¥ Install PHP dependencies
      run: composer install --prefer-dist --no-progress

    # 5ï¸âƒ£ Deploy qua FTP lÃªn DirectAdmin
    - name: ğŸš€ Deploy to DirectAdmin via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        port: ${{ secrets.FTP_PORT }}
        server-dir: ${{ secrets.FTP_PATH }}
        local-dir: ./
        protocol: ftp
        dangerous-clean-slate: false   # Giá»¯ láº¡i cÃ¡c file cÅ©, chá»‰ ghi Ä‘Ã¨ file má»›i

    # 6ï¸âƒ£ Ghi log sau khi deploy
    - name: âœ… Deployment summary
      run: |
        echo "ğŸ‰ Deploy completed successfully!"
        echo "ğŸŒ Website: https://${{ secrets.FTP_SERVER }}"
        echo "ğŸ“‚ Path on server: ${{ secrets.FTP_PATH }}"
        echo "ğŸ•’ Deployment time: $(date)"
